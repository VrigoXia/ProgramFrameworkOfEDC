C51 COMPILER V8.05a   STC15_IIC                                                            08/02/2017 19:00:47 PAGE 1   


C51 COMPILER V8.05a, COMPILATION OF MODULE STC15_IIC
OBJECT MODULE PLACED IN .\stc15_iic.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\HARDWARE\COMMON_HARDWARE\BSP\IIC\stc15_iic.c LARGE WARNINGLEVEL(0) BR
                    -OWSE DEBUG OBJECTEXTEND PRINT(.\stc15_iic.lst) TABS(2) OBJECT(.\stc15_iic.obj)

line level    source

   1          /************************************************************
   2          * 组织名称： (C), 1988-1999, Tech. Co., Ltd.
   3          * 文件名称: test.cpp
   4          * 作者:
   5          * 版本 :
   6          * 日期:
   7          * 描述: // 模块描述
   8          * 主要函数及其功能 : // 主要函数及其功能
   9            1. -------
  10          * 历史修改记录: // 历史修改记录
  11          * <作者> <时间> <版本 > <描述>
  12          * David 96/10/12 1.0 build this moudle
  13          ***********************************************************/
  14          #include    "stc15_iic.h"
  15          #include <stdio.h>
  16          #include "../USART1/USART1.h"
  17          /* ***************************************************** */
  18          // 函数名称：Delay5US()
  19          // 函数功能：5微秒延时,如果自己的主频有变，请自行修改
  20          // 入口参数：无
  21          // 出口参数：无
  22          /* ***************************************************** */
  23          void Delay5US(void)     //@24MHz
  24          {
  25   1         
  26   1      unsigned char i;
  27   1      
  28   1        _nop_();
  29   1        _nop_();
  30   1        i = 57;
  31   1        while (--i);
  32   1      }
  33          /* ***************************************************** */
  34          // 函数名称：IIC_Start()
  35          // 函数功能：IIC起动
  36          // 入口参数：无
  37          // 出口参数：无
  38          /* ***************************************************** */
  39          void IIC_Start(void)
  40          {
  41   1          SDA = 1;
  42   1          Delay5US();
  43   1          SCL = 1;
  44   1          Delay5US();
  45   1          SDA = 0;
  46   1          Delay5US();
  47   1      }
  48          /* ***************************************************** */
  49          // 函数名称：IIC_Stop()
  50          // 函数功能：IIC停止
  51          // 入口参数：无
  52          // 出口参数：无
  53          /* ***************************************************** */
  54          void IIC_Stop(void)
C51 COMPILER V8.05a   STC15_IIC                                                            08/02/2017 19:00:47 PAGE 2   

  55          {
  56   1          SDA = 0;
  57   1          Delay5US();
  58   1          SCL = 1;
  59   1          Delay5US();
  60   1          SDA =1;
  61   1      }
  62          /* ***************************************************** */
  63          // 函数名称：IIC_Ack()
  64          // 函数功能：IIC应答
  65          // 入口参数：无
  66          // 出口参数：无
  67          /* ***************************************************** */
  68          void IIC_Ack(void)
  69          {
  70   1          SCL = 0;                // 为产生脉冲准备
  71   1          SDA = 0;                // 产生应答信号
  72   1          Delay5US();             // 延时你懂得
  73   1          SCL = 1;
  74   1          Delay5US();
  75   1          SCL = 0;
  76   1          Delay5US();     // 产生高脉冲
  77   1          SDA = 1;                // 释放总线
  78   1      }
  79          /* ***************************************************** */
  80          // 函数名称：IIC_RdAck()
  81          // 函数功能：读IIC应答
  82          // 入口参数：无
  83          // 出口参数：是否应答真值
  84          /* ***************************************************** */
  85          BOOL IIC_RdAck(void)
  86          {
  87   1          BOOL AckFlag;
  88   1          u8 uiVal = 0;
  89   1          SCL = 0;
  90   1          Delay5US();
  91   1          SDA = 1;
  92   1          SCL = 1;
  93   1          Delay5US();
  94   1           while((1 == SDA) && (uiVal < 255))
  95   1          {
  96   2              uiVal ++;
  97   2              AckFlag = SDA;
  98   2          }
  99   1          SCL = 0;
 100   1          return AckFlag;     // 应答返回：0;不应答返回：1
 101   1      }
 102          /* ***************************************************** */
 103          // 函数名称：IIC_Nack()
 104          // 函数功能：IIC不应答
 105          // 入口参数：无
 106          // 出口参数：无
 107          /* ***************************************************** */
 108          void IIC_Nack(void)
 109          {
 110   1          SDA = 1;
 111   1          SCL = 0;
 112   1          Delay5US();
 113   1          SCL = 1;
 114   1          Delay5US();
 115   1          SCL = 0;
 116   1      }
C51 COMPILER V8.05a   STC15_IIC                                                            08/02/2017 19:00:47 PAGE 3   

 117          /* ***************************************************** */
 118          // 函数名称：OutputOneByte()
 119          // 函数功能：从IIC器件中读出一个字节
 120          // 入口参数：无
 121          // 出口参数：读出的一个字节（uByteVal）
 122          /* ***************************************************** */
 123          u8 OutputOneByte(void)
 124          {
 125   1      //    u8 uByteVal = 0;
 126   1      //    u8 iCount;
 127   1      //    SDA = 1;
 128   1      //    for (iCount = 0; iCount < 8; iCount++)
 129   1      //    {
 130   1      //        SCL = 0;
 131   1      //        Delay5US();
 132   1      //        SCL = 1;
 133   1      //        Delay5US();
 134   1      //        uByteVal <<= 1;
 135   1      //        if(SDA)
 136   1      //        {
 137   1      //            uByteVal |= 0x01;
 138   1      //        }
 139   1      //    }
 140   1      //    SCL = 0;
 141   1      //    return(uByteVal);
 142   1        u8 str[8];
 143   1          unsigned char i;
 144   1          unsigned char Data=0;       //定义一个缓冲寄存器。
 145   1          for(i=0;i<8;i++)//有8位数据
 146   1              {
 147   2                SCL=1;//拉高时钟线，为读取下一位数据做准备。
 148   2                Delay5US();
 149   2                Data=Data<<1;//将缓冲字节的数据左移一位，准备读取数据。
 150   2                Delay5US();
 151   2                if (SDA==1)//如果数据线为高平电平。
 152   2                {
 153   3                  Data = Data | 0x1;//则给缓冲字节的最低位写1。
 154   3                }
 155   2                else
 156   2                {
 157   3                  Data = Data | 0x0;//
 158   3                }
 159   2                  
 160   2                 SCL=0;//拉低时钟线，为读取下一位数据做准备。
 161   2                 Delay5US();
 162   2              }
 163   1      
 164   1          return Data;//返回读取的一个字节数据。
 165   1          }
 166          /* ***************************************************** */
 167          // 函数名称：InputOneByte()
 168          // 函数功能：向IIC器件写入一个字节
 169          // 入口参数：待写入的一个字节（uByteVal）
 170          // 出口参数：无
 171          /* ***************************************************** */
 172          void InputOneByte(u8 uByteVal)
 173          {
 174   1          u8 iCount;
 175   1          for(iCount = 0; iCount < 8; iCount++)
 176   1          {
 177   2              SCL = 0;
 178   2              Delay5US();
C51 COMPILER V8.05a   STC15_IIC                                                            08/02/2017 19:00:47 PAGE 4   

 179   2              SDA = (uByteVal & 0x80) >> 7;
 180   2              Delay5US();
 181   2              SCL = 1;
 182   2              Delay5US();
 183   2              uByteVal <<= 1;
 184   2          }
 185   1          SCL = 0;
 186   1      }
 187          /* ***************************************************** */
 188          // 函数名称：IIC_WrDevAddAndDatAdd()
 189          // 函数功能：向IIC器件写入器件和数据地址
 190          // 入口参数：器件地址（uDevAdd），数据地址（uDatAdd）
 191          // 出口参数：写入是否成功真值
 192          /* ***************************************************** */
 193          BOOL IIC_WrDevAddAndDatAdd(u8 uDevAdd,u8 uDatAdd)
 194          {
 195   1          IIC_Start();            // 发送开始信号
 196   1          InputOneByte(uDevAdd);  // 输入器件地址
 197   1          IIC_RdAck();            // 读应答信号
 198   1          InputOneByte(uDatAdd);  // 输入数据地址
 199   1          IIC_RdAck();            // 读应答信号
 200   1          return TRUE;
 201   1      }
 202          /* ***************************************************** */
 203          // 函数名称：IIC_WrDatToAdd()
 204          // 函数功能：向IIC器件写数据
 205          // 入口参数：器件ID(uDevID)、数据存储起始地址(uStaAddVal)
 206          //           待存数据(*p)、连续存储数据的个数(uiLenVal)
 207          // 出口参数：无
 208          /* ***************************************************** */
 209          void IIC_WrDatToAdd(u8 uDevID, u8 uStaAddVal, u8 *p, u8 ucLenVal)
 210          {
 211   1          u8 iCount;
 212   1          IIC_WrDevAddAndDatAdd(uDevID | IIC_WRITE,uStaAddVal);
 213   1          // IIC_WRITE 为写命令后缀符
 214   1          for(iCount = 0; iCount < ucLenVal; iCount++)
 215   1          {
 216   2              InputOneByte(*p++);
 217   2              IIC_RdAck();
 218   2          }
 219   1          IIC_Stop();
 220   1      }
 221          /* ***************************************************** */
 222          // 函数名称：IIC_RdDatFromAdd()
 223          // 函数功能：向IIC器件读数据
 224          // 入口参数：器件ID(uDevID)、数据存储地址(uStaAddVal)
 225          //           待存数据(*p)、连续存储数据的个数(uiLenVal)
 226          // 出口参数：无
 227          /* ***************************************************** */
 228          void IIC_RdDatFromAdd(u8 uDevID, u8 uStaAddVal, u8 *p, u8 uiLenVal)
 229          {
 230   1          u8 iCount;
 231   1          IIC_WrDevAddAndDatAdd(uDevID | IIC_WRITE,uStaAddVal);
 232   1          IIC_Start();
 233   1          InputOneByte(uDevID | IIC_READ);
 234   1          // IIC_READ 为写命令后缀符
 235   1          IIC_RdAck();
 236   1          for(iCount = 0; iCount < uiLenVal; iCount++)
 237   1          {
 238   2              *p++ = OutputOneByte();
 239   2              if(iCount != (uiLenVal - 1))
 240   2              {
C51 COMPILER V8.05a   STC15_IIC                                                            08/02/2017 19:00:47 PAGE 5   

 241   3                  IIC_Ack();
 242   3              }
 243   2          }
 244   1          IIC_Nack();
 245   1          IIC_Stop();
 246   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    328    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
